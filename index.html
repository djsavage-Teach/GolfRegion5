<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Region 5 Live Scoring</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Mobile-First Base Styles */
        body { -webkit-tap-highlight-color: transparent; }
        .active-tab { border-bottom: 4px solid #15803d; color: #15803d; }
        .loader { border-top-color: #15803d; animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .centered-container {
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Leaderboard Grid - Optimized for Mobile */
        .lb-grid {
            display: grid;
            grid-template-columns: 35px 1fr 55px 45px;
            align-items: center;
            gap: 4px;
        }

        /* Player Scores Grid - Optimized for Mobile */
        .scores-grid {
            display: grid;
            grid-template-columns: 1fr 60px 45px;
            align-items: center;
            gap: 4px;
        }

        .rank-cell { text-align: left; font-weight: 900; color: #6b7280; font-size: 0.875rem; }
        .name-cell { display: flex; align-items: center; font-weight: 800; text-transform: uppercase; overflow: hidden; }
        .name-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9rem; }
        .score-cell { text-align: center; font-weight: 900; font-style: italic; font-size: 1.25rem; }
        .holes-cell { text-align: right; font-weight: 700; color: #9ca3af; font-size: 0.75rem; }

        .giant-header {
            font-size: 1.1rem;
            font-weight: 900;
            text-transform: uppercase;
            text-align: center;
            background-color: #15803d;
            color: white;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 4px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        .sub-header-labels {
            display: grid;
            grid-template-columns: 35px 1fr 55px 45px;
            font-size: 9px;
            font-weight: 900;
            color: #9ca3af;
            text-transform: uppercase;
            padding: 4px 12px;
            letter-spacing: 0.05em;
        }

        .scores-header-labels {
            display: grid;
            grid-template-columns: 1fr 60px 45px;
            font-size: 9px;
            font-weight: 900;
            color: #9ca3af;
            text-transform: uppercase;
            padding: 10px 12px;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #e5e7eb;
        }

        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        .header-gradient {
            background: linear-gradient(180deg, #064e3b 0%, #14532d 100%);
        }

        /* School Logo Banner - Responsive wrapping */
        .school-banner {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(4px);
            margin-top: 15px;
            border-radius: 12px;
        }
        
        .school-logo {
            width: 32px;
            height: 32px;
            object-fit: contain;
            background: white;
            padding: 2px;
            border-radius: 4px;
        }

        .inline-logo {
            width: 20px;
            height: 20px;
            min-width: 20px;
            object-fit: contain;
            display: inline-block;
            vertical-align: middle;
            margin-right: 6px;
            background: white;
            padding: 1px;
            border-radius: 3px;
        }

        /* Responsive adjustments for larger screens */
        @media (min-width: 640px) {
            .lb-grid { grid-template-columns: 50px 1fr 70px 60px; }
            .scores-grid { grid-template-columns: 1fr 80px 60px; }
            .sub-header-labels { grid-template-columns: 50px 1fr 70px 60px; font-size: 10px; }
            .scores-header-labels { grid-template-columns: 1fr 80px 60px; font-size: 10px; }
            .name-text { font-size: 1.1rem; }
            .giant-header { font-size: 1.5rem; }
            .school-logo { width: 40px; height: 40px; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-gray-900">

    <header class="header-gradient text-white shadow-xl sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-4 pt-4 pb-2">
            <div class="relative flex flex-col items-center">
                <div class="absolute right-0 top-0">
                    <button onclick="refreshData()" class="p-2 bg-white/10 hover:bg-white/20 rounded-lg transition-all active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                </div>
                
                <div class="flex flex-col items-center text-center w-full">
                    <div class="flex items-center justify-center space-x-2">
                        <span class="text-2xl">⛳</span>
                        <h1 class="text-2xl sm:text-4xl font-black tracking-tighter uppercase italic">Region 5</h1>
                    </div>
                    <span class="text-[10px] sm:text-xs font-bold tracking-[0.3em] text-green-300 uppercase opacity-90">Live Scoring Hub</span>
                    
                    <div id="school-logo-banner" class="school-banner"></div>
                </div>
            </div>
        </div>

        <div class="flex justify-center bg-white text-gray-500 text-[11px] sm:text-sm font-bold uppercase border-b shadow-sm overflow-x-auto scrollbar-hide">
            <button onclick="setView('leaderboard')" id="tab-leaderboard" class="px-4 py-3 active-tab whitespace-nowrap">Individuals</button>
            <button onclick="setView('teams')" id="tab-teams" class="px-4 py-3 whitespace-nowrap">Teams</button>
            <button onclick="setView('scores')" id="tab-scores" class="px-4 py-3 whitespace-nowrap">Scores</button>
            <button onclick="setView('input')" id="tab-input" class="px-4 py-3 whitespace-nowrap">Enter</button>
        </div>
    </header>

    <main class="max-w-5xl mx-auto p-3 pb-24">
        <!-- Individuals -->
        <div id="view-leaderboard" class="view">
            <div class="centered-container"><div id="leaderboard-list" class="grid gap-1.5"></div></div>
        </div>

        <!-- Teams -->
        <div id="view-teams" class="view hidden">
            <div class="centered-container"><div id="teams-list" class="grid gap-1.5"></div></div>
        </div>

        <!-- All Scores -->
        <div id="view-scores" class="view hidden">
            <div class="centered-container">
                <div class="mb-3">
                    <input type="text" onkeyup="filterPlayerScores(this.value)" placeholder="Search players..." class="w-full p-3 rounded-xl border border-gray-300 shadow-sm outline-none focus:ring-2 focus:ring-green-500 text-base">
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="scores-header-labels bg-gray-50">
                        <div>PLAYER</div>
                        <div class="text-center">SCORE</div>
                        <div class="text-right pr-2">THRU</div>
                    </div>
                    <div id="scores-list" class="divide-y divide-gray-100"></div>
                </div>
            </div>
        </div>

        <!-- Entry Page -->
        <div id="view-input" class="view hidden">
            <div class="bg-white p-5 rounded-2xl shadow-lg max-w-lg mx-auto border">
                <h2 class="text-lg font-black text-center mb-4 uppercase">Submit Group Scores</h2>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <select id="groupSelect" onchange="loadGroupPlayers()" class="w-full p-3 border rounded-xl bg-gray-50 font-bold text-sm">
                            <option value="">Group...</option>
                            <option value="Group 1">1</option><option value="Group 2">2</option><option value="Group 3">3</option><option value="Group 4">4</option><option value="Group 5">5</option><option value="Group 6">6</option><option value="Group 7">7</option><option value="Group 8">8</option><option value="Group 9">9</option><option value="Group 10">10</option><option value="Group 11">11</option><option value="Group 12">12</option><option value="Group 13">13</option><option value="Group 14">14</option><option value="Group 15">15</option><option value="Group 16">16</option>
                        </select>
                        <select id="holeSelect" class="w-full p-3 border rounded-xl bg-gray-50 font-bold text-sm">
                            <option value="1">Hole 1</option><option value="2">Hole 2</option><option value="3">Hole 3</option><option value="4">Hole 4</option><option value="5">Hole 5</option><option value="6">Hole 6</option><option value="7">Hole 7</option><option value="8">Hole 8</option><option value="9">Hole 9</option><option value="10">Hole 10</option><option value="11">Hole 11</option><option value="12">Hole 12</option><option value="13">Hole 13</option><option value="14">Hole 14</option><option value="15">Hole 15</option><option value="16">Hole 16</option><option value="17">Hole 17</option><option value="18">Hole 18</option>
                        </select>
                    </div>
                    <div id="group-player-inputs" class="space-y-2 py-2"></div>
                    <button id="submitBtn" onclick="submitScores()" disabled class="w-full bg-green-700 text-white font-black py-4 rounded-xl shadow-lg disabled:opacity-30 uppercase text-sm">Submit Scores</button>
                    <div id="statusMsg" class="text-center font-bold p-3 rounded-lg hidden text-sm"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const DEPLOY_URL = "https://script.google.com/macros/s/AKfycbzZob3wO7GbG1G3l9mNd3TozlqQpyMe4ekgdvuJev3v1549jpm3t2ovnG9wLZ5cVwgzxw/exec";

        const SCHOOLS = [
            { name: "Box Elder", url: "https://cmsv2-assets.apptegy.net/uploads/7672/logo/9154/bee_new.png" },
            { name: "Bonneville", url: "https://core-docs.s3.amazonaws.com/weber_school_district__ut_ar/article/image/large_b2cffc0f-68ec-428c-a650-81767d56453b.png" },
            { name: "West Field", url: "https://assets.hometownticketing.com/clients/westfield/logos/school_logo_ebc133bd.png" },
            { name: "Fremont", url: "https://assets.hometownticketing.com/clients/fremontathletics/logos/school_logo_c1182661.png" },
            { name: "Northridge", url: "https://sportshub2-uploads.vnn-prod.zone/files/sites/429/2020/09/29204806/KnightVectorGraphic.png" },
            { name: "Clearfield", url: "https://cmsv2-assets.apptegy.net/uploads/22258/file/3291122/77646c73-243c-4814-b16b-1a9a686cfc78.png" },
            { name: "Roy", url: "https://cmsv2-assets.apptegy.net/uploads/25031/file/5081095/46ab505e-f612-4145-9e63-ec68e8782242.jpeg" }
        ];

        function getLogoHtml(text) {
            if (!text) return "";
            const match = SCHOOLS.find(s => text.toUpperCase().includes(s.name.toUpperCase()));
            return match ? `<img src="${match.url}" class="inline-logo" alt="${match.name}">` : "";
        }

        function initLogos() {
            const banner = document.getElementById('school-logo-banner');
            banner.innerHTML = SCHOOLS.map(school => `
                <img src="${school.url}" alt="${school.name}" class="school-logo shadow-sm">
            `).join('');
        }

        function setView(view) {
            document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${view}`).classList.remove('hidden');
            document.querySelectorAll('header button').forEach(el => el.classList.remove('active-tab'));
            document.getElementById(`tab-${view}`).classList.add('active-tab');
            
            if (view === 'leaderboard') fetchLeaderboard('individual');
            if (view === 'teams') fetchLeaderboard('team');
            if (view === 'scores') fetchPlayerScores();
        }

        const createGiantHeader = (title, label) => `
            <div class="giant-header mt-2">${title}</div>
            <div class="sub-header-labels">
                <div>RANK</div>
                <div style="text-align: center;">${label}</div>
                <div style="text-align: center;">SCORE</div>
                <div style="text-align: right;">THRU</div>
            </div>
        `;

        const createRow = (p) => {
            const keys = Object.keys(p);
            const rank = p[keys[0]] || "-";
            const name = p[keys[1]] || "Unknown";
            const score = p[keys[2]] || "E";
            const holes = p[keys[3]] || "0";
            const isUnder = String(score).startsWith('-');

            return `
                <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 lb-grid">
                    <div class="rank-cell">${rank}</div>
                    <div class="name-cell">
                        ${getLogoHtml(name)}
                        <span class="name-text">${name}</span>
                    </div>
                    <div class="score-cell ${isUnder ? 'text-red-600' : 'text-gray-800'}">${score}</div>
                    <div class="holes-cell">${holes}</div>
                </div>
            `;
        };

        async function fetchLeaderboard(type = 'individual') {
            const listId = type === 'individual' ? 'leaderboard-list' : 'teams-list';
            const list = document.getElementById(listId);
            list.innerHTML = `<div class="flex justify-center py-12"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10"></div></div>`;
            
            try {
                const res = await fetch(`${DEPLOY_URL}?action=getLeaderboard`);
                const data = await res.json();
                
                let html = (type === 'individual') ? createGiantHeader('Individuals', 'PLAYER') : createGiantHeader('Teams', 'TEAM');
                let isTeamSection = false;
                let count = 0;

                data.forEach((p, index) => {
                    const keys = Object.keys(p);
                    const nameVal = String(p[keys[1]] || "").trim().toUpperCase();
                    if (index >= 13 || nameVal.includes("TEAM") || nameVal.includes("LEADERS")) {
                        if (!isTeamSection && (nameVal.includes("TEAM") || index >= 13)) isTeamSection = true;
                    }
                    if (nameVal === "PLAYER" || nameVal === "TEAM" || nameVal === "" || nameVal.includes("TEAM LEADERS")) return;

                    if (type === 'individual' && !isTeamSection) {
                        if (count < 12) { html += createRow(p); count++; }
                    } else if (type === 'team' && isTeamSection) {
                        html += createRow(p);
                        count++;
                    }
                });
                list.innerHTML = count > 0 ? html : `<div class="p-10 text-center text-gray-400">Updating...</div>`;
            } catch (e) { list.innerHTML = `<div class="p-6 text-center text-red-500 font-bold">Network Error.</div>`; }
        }

        async function fetchPlayerScores() {
            const list = document.getElementById('scores-list');
            list.innerHTML = `<div class="flex justify-center py-12"><div class="loader rounded-full border-4 border-t-4 border-gray-200 h-10 w-10"></div></div>`;
            try {
                const res = await fetch(`${DEPLOY_URL}?action=getAllScores`);
                const data = await res.json();
                
                list.innerHTML = data.slice(2).map(p => {
                    const keys = Object.keys(p);
                    const name = (p[keys[2]] || "").toString().trim(); 
                    const thru = (p[keys[24]] || "0").toString().trim(); 
                    const score = (p[keys[25]] || "E").toString().trim(); 
                    if(!name || name.toUpperCase() === "PLAYER NAME" || name === "") return null;
                    const isUnder = String(score).startsWith('-');
                    
                    return `
                        <div class="p-3 score-entry scores-grid">
                            <span class="font-bold text-gray-800 uppercase flex items-center overflow-hidden">
                                ${getLogoHtml(name)}
                                <span class="truncate text-[0.85rem] sm:text-base">${name}</span>
                            </span>
                            <span class="text-lg font-black text-center ${isUnder ? 'text-red-600' : 'text-green-700'}">${score}</span>
                            <span class="text-xs font-bold text-gray-400 text-right pr-2">${thru}</span>
                        </div>`;
                }).filter(html => html !== null).join('');
            } catch (e) { list.innerHTML = `<div class="p-10 text-center text-red-500">Error loading.</div>`; }
        }

        async function loadGroupPlayers() {
            const groupVal = document.getElementById('groupSelect').value;
            const container = document.getElementById('group-player-inputs');
            if (!groupVal) return container.innerHTML = "";
            const groupTab = groupVal.replace("Group ", "G");
            container.innerHTML = `<div class="flex justify-center py-4"><div class="loader border-2 h-6 w-6"></div></div>`;
            
            try {
                const res = await fetch(`${DEPLOY_URL}?action=getGroupPlayers&groupTab=${encodeURIComponent(groupTab)}`);
                const players = await res.json();
                const actualPlayers = players.filter(name => {
                    if (!name) return false;
                    const n = name.toString().trim().toUpperCase();
                    return n !== "" && n !== "HOLE" && n !== "PAR" && n !== "PLAYER" && n !== "NAME";
                });

                container.innerHTML = actualPlayers.map(name => `
                    <div class="flex items-center justify-between p-2.5 bg-gray-50 rounded-xl border border-gray-200">
                        <span class="font-bold text-gray-700 text-[0.8rem] uppercase flex items-center overflow-hidden mr-2">
                            ${getLogoHtml(name)}
                            <span class="truncate">${name}</span>
                        </span>
                        <input type="number" inputmode="numeric" data-player="${name}" placeholder="Par" class="player-score-input w-16 p-2 border rounded-lg text-center font-bold text-lg focus:ring-2 focus:ring-green-500">
                    </div>
                `).join('');
                document.getElementById('submitBtn').disabled = false;
            } catch (e) { container.innerHTML = `<div class="text-red-500 text-center text-xs">Error.</div>`; }
        }

        async function submitScores() {
            const groupVal = document.getElementById('groupSelect').value;
            const groupTab = groupVal.replace("Group ", "G");
            const hole = document.getElementById('holeSelect').value;
            const btn = document.getElementById('submitBtn');
            const scores = {};
            let hasScores = false;
            document.querySelectorAll('.player-score-input').forEach(i => { 
                if(i.value) { scores[i.getAttribute('data-player')] = i.value; hasScores = true; }
            });
            if (!hasScores) return showStatus("Enter a score.", false);
            btn.disabled = true; btn.innerText = "SUBMITTING...";

            try {
                const response = await fetch(DEPLOY_URL, { method: 'POST', body: JSON.stringify({ groupTab, holeNum: hole, scores }) });
                const result = await response.json();
                if (result.result === "success") {
                    showStatus(`✓ Hole ${hole} updated!`, true);
                    document.querySelectorAll('.player-score-input').forEach(i => i.value = '');
                } else showStatus("Submission failed.", false);
            } catch (e) { showStatus("Network error.", false); }
            finally { btn.disabled = false; btn.innerText = "SUBMIT SCORES"; }
        }

        function showStatus(msg, success) {
            const s = document.getElementById('statusMsg');
            s.innerText = msg; s.className = `text-center p-3 rounded-lg block font-bold mt-3 ${success ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            s.classList.remove('hidden'); setTimeout(() => s.classList.add('hidden'), 5000);
        }

        function filterPlayerScores(q) {
            const items = document.querySelectorAll('.score-entry');
            const searchTerm = q.toLowerCase();
            items.forEach(i => i.style.display = i.innerText.toLowerCase().includes(searchTerm) ? '' : 'none');
        }

        function refreshData() {
            const active = document.querySelector('header button.active-tab').id;
            if (active === 'tab-leaderboard') fetchLeaderboard('individual');
            if (active === 'tab-teams') fetchLeaderboard('team');
            if (active === 'tab-scores') fetchPlayerScores();
        }

        window.onload = () => { initLogos(); fetchLeaderboard('individual'); };
    </script>
</body>
</html>
