<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Region 5 Live Scoring</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

        :root {
            --primary-color: #15803d;
            --primary-dark: #064e3b;
        }

        body { 
            -webkit-tap-highlight-color: transparent; 
            font-family: 'Inter', sans-serif;
            transition: background-color 0.5s ease;
        }

        .active-tab { border-bottom: 4px solid var(--primary-color); color: var(--primary-color); }
        
        /* Glassmorphism Header */
        .glass-header {
            background: rgba(20, 83, 45, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Monospace for numbers to ensure alignment */
        .tabular-nums { font-variant-numeric: tabular-nums; letter-spacing: -0.02em; }

        /* Animation: Staggered Entrance */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .row-animate {
            animation: fadeInUp 0.4s ease forwards;
            opacity: 0;
        }

        /* Skeleton Loaders */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .centered-container { max-width: 600px; margin: 0 auto; }

        .lb-grid {
            display: grid;
            grid-template-columns: 32px 1fr 48px 42px;
            align-items: center;
            gap: 2px;
        }

        .rank-cell { text-align: left; font-weight: 900; color: #6b7280; font-size: 0.8rem; }
        .name-cell { display: flex; align-items: center; font-weight: 800; text-transform: uppercase; overflow: hidden; min-width: 0; }
        .name-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.85rem; flex: 1; }
        .score-cell { text-align: center; font-weight: 900; font-style: italic; font-size: 1.1rem; }
        .holes-cell { text-align: right; font-weight: 700; color: #9ca3af; font-size: 0.7rem; }

        .giant-header {
            font-size: 1.1rem;
            font-weight: 900;
            text-transform: uppercase;
            text-align: center;
            background-color: var(--primary-color);
            color: white;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 4px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            transition: background-color 0.5s ease;
        }

        .sub-header-labels {
            display: grid;
            grid-template-columns: 32px 1fr 48px 42px;
            font-size: 8px;
            font-weight: 900;
            color: #9ca3af;
            text-transform: uppercase;
            padding: 4px 10px;
        }

        .school-banner {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 6px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-top: 12px;
        }
        
        .school-logo { width: 28px; height: 28px; object-fit: contain; background: white; padding: 2px; border-radius: 4px; }
        .inline-logo { width: 18px; height: 18px; min-width: 18px; object-fit: contain; display: inline-block; vertical-align: middle; margin-right: 4px; background: white; padding: 1px; border-radius: 3px; }

        /* Favorite Pinning Star */
        .fav-star { font-size: 14px; margin-right: 4px; cursor: pointer; color: #d1d5db; transition: color 0.2s; }
        .fav-star.active { color: #f59e0b; }

        /* Pulse Indicator */
        .pulse-live {
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
            box-shadow: 0 0 0 rgba(239, 68, 68, 0.4);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        @media (min-width: 640px) {
            .lb-grid { grid-template-columns: 50px 1fr 70px 60px; gap: 8px; }
            .name-text { font-size: 1.1rem; }
            .rank-cell { font-size: 1rem; }
            .score-cell { font-size: 1.5rem; }
            .giant-header { font-size: 1.5rem; }
            .school-logo { width: 36px; height: 36px; }
        }

        /* Pull to refresh UI */
        #pull-to-refresh {
            height: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            transition: height 0.2s;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-900 overflow-x-hidden">

    <div id="pull-to-refresh" class="text-xs font-bold text-gray-400 uppercase tracking-widest">
        Release to Refresh
    </div>

    <header class="glass-header text-white shadow-xl sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-4 pt-3 pb-2">
            <div class="relative flex flex-col items-center">
                <div class="absolute left-0 top-0 flex items-center pt-2">
                    <span class="pulse-live"></span>
                    <span class="text-[10px] font-bold uppercase tracking-widest opacity-80">Live</span>
                </div>
                <div class="absolute right-0 top-0">
                    <button onclick="refreshData()" class="p-2 bg-white/10 hover:bg-white/20 rounded-lg transition-all active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                </div>
                
                <div class="flex flex-col items-center text-center w-full">
                    <div class="flex items-center justify-center space-x-2">
                        <h1 class="text-xl sm:text-3xl font-black tracking-tighter uppercase italic">Region 5</h1>
                    </div>
                    <span class="text-[9px] sm:text-xs font-bold tracking-[0.3em] text-green-300 uppercase opacity-90">Live Scoring Hub</span>
                    <div id="school-logo-banner" class="school-banner"></div>
                </div>
            </div>
        </div>

        <div class="flex justify-center bg-white text-gray-500 text-[11px] sm:text-sm font-bold uppercase border-b shadow-sm overflow-x-auto scrollbar-hide">
            <button onclick="setView('leaderboard')" id="tab-leaderboard" class="px-5 py-3 active-tab transition-all">Individuals</button>
            <button onclick="setView('teams')" id="tab-teams" class="px-5 py-3 transition-all">Teams</button>
            <button onclick="setView('scores')" id="tab-scores" class="px-5 py-3 transition-all">Scores</button>
            <button onclick="setView('input')" id="tab-input" class="px-5 py-3 transition-all">Enter</button>
        </div>
    </header>

    <main id="main-content" class="max-w-5xl mx-auto p-2 sm:p-4 pb-24">
        <div id="view-leaderboard" class="view">
            <div class="centered-container"><div id="leaderboard-list" class="grid gap-1"></div></div>
        </div>
        <div id="view-teams" class="view hidden">
            <div class="centered-container"><div id="teams-list" class="grid gap-1"></div></div>
        </div>
        <div id="view-scores" class="view hidden">
            <div class="centered-container">
                <div class="mb-3 px-1">
                    <input type="text" onkeyup="filterPlayerScores(this.value)" placeholder="Search players..." class="w-full p-3 rounded-xl border border-gray-300 shadow-inner outline-none focus:ring-2 focus:ring-green-500 text-base">
                </div>
                <div id="scores-list" class="grid gap-1"></div>
            </div>
        </div>
        <div id="view-input" class="view hidden">
            <div class="bg-white p-5 rounded-2xl shadow-lg max-w-lg mx-auto border border-gray-100">
                <h2 class="text-lg font-black text-center mb-4 uppercase">Submit Group Scores</h2>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <select id="groupSelect" onchange="loadGroupPlayers()" class="w-full p-3 border rounded-xl bg-gray-50 font-bold text-sm">
                            <option value="">Group...</option>
                            <option value="Group 1">1</option><option value="Group 2">2</option><option value="Group 3">3</option><option value="Group 4">4</option><option value="Group 5">5</option><option value="Group 6">6</option><option value="Group 7">7</option><option value="Group 8">8</option><option value="Group 9">9</option><option value="Group 10">10</option><option value="Group 11">11</option><option value="Group 12">12</option><option value="Group 13">13</option><option value="Group 14">14</option><option value="Group 15">15</option><option value="Group 16">16</option>
                        </select>
                        <select id="holeSelect" class="w-full p-3 border rounded-xl bg-gray-50 font-bold text-sm">
                            <option value="1">Hole 1</option><option value="2">Hole 2</option><option value="3">Hole 3</option><option value="4">Hole 4</option><option value="5">Hole 5</option><option value="6">Hole 6</option><option value="7">Hole 7</option><option value="8">Hole 8</option><option value="9">Hole 9</option><option value="10">Hole 10</option><option value="11">Hole 11</option><option value="12">Hole 12</option><option value="13">Hole 13</option><option value="14">Hole 14</option><option value="15">Hole 15</option><option value="16">Hole 16</option><option value="17">Hole 17</option><option value="18">Hole 18</option>
                        </select>
                    </div>
                    <div id="group-player-inputs" class="space-y-2 py-2"></div>
                    <button id="submitBtn" onclick="submitScores()" disabled class="w-full bg-green-700 text-white font-black py-4 rounded-xl shadow-lg disabled:opacity-30 uppercase text-sm">Submit Scores</button>
                    <div id="statusMsg" class="text-center font-bold p-3 rounded-lg hidden text-sm"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const DEPLOY_URL = "https://script.google.com/macros/s/AKfycbzZob3wO7GbG1G3l9mNd3TozlqQpyMe4ekgdvuJev3v1549jpm3t2ovnG9wLZ5cVwgzxw/exec";
        let favorites = JSON.parse(localStorage.getItem('golf_favs') || '[]');

        const SCHOOLS = [
            { name: "BOX ELDER", url: "https://cmsv2-assets.apptegy.net/uploads/7672/logo/9154/bee_new.png", color: "#facc15" },
            { name: "BONNEVILLE", url: "https://core-docs.s3.amazonaws.com/weber_school_district__ut_ar/article/image/large_b2cffc0f-68ec-428c-a650-81767d56453b.png", color: "#1e40af" },
            { name: "WEST FIELD", url: "https://assets.hometownticketing.com/clients/westfield/logos/school_logo_ebc133bd.png", color: "#dc2626" },
            { name: "FREMONT", url: "https://assets.hometownticketing.com/clients/fremontathletics/logos/school_logo_c1182661.png", color: "#1e3a8a" },
            { name: "NORTHRIDGE", url: "https://sportshub2-uploads.vnn-prod.zone/files/sites/429/2020/09/29204806/KnightVectorGraphic.png", color: "#991b1b" },
            { name: "CLEARFIELD", url: "https://cmsv2-assets.apptegy.net/uploads/22258/file/3291122/77646c73-243c-4814-b16b-1a9a686cfc78.png", color: "#14532d" },
            { name: "ROY", url: "https://cmsv2-assets.apptegy.net/uploads/25031/file/5081095/46ab505e-f612-4145-9e63-ec68e8782242.jpeg", color: "#6b21a8" }
        ];

        function getLogoHtml(text) {
            const match = SCHOOLS.find(s => text.toUpperCase().includes(s.name));
            return match ? `<img src="${match.url}" class="inline-logo shadow-sm" alt="${match.name}">` : "";
        }

        function updateBranding(topName) {
            const match = SCHOOLS.find(s => topName.toUpperCase().includes(s.name));
            if (match) {
                document.documentElement.style.setProperty('--primary-color', match.color);
            }
        }

        function toggleFavorite(name) {
            if (favorites.includes(name)) favorites = favorites.filter(f => f !== name);
            else favorites.push(name);
            localStorage.setItem('golf_favs', JSON.stringify(favorites));
            refreshData();
        }

        function initLogos() {
            const banner = document.getElementById('school-logo-banner');
            banner.innerHTML = SCHOOLS.map(school => `
                <img src="${school.url}" alt="${school.name}" class="school-logo shadow-sm border border-gray-100">
            `).join('');
        }

        function createSkeleton(count) {
            return `<div class="giant-header skeleton h-12 w-full mt-1 mb-6 rounded-xl opacity-20"></div>` + 
                   Array(count).fill(0).map(() => `
                <div class="bg-white p-4 rounded-xl shadow-sm lb-grid opacity-40 mb-1">
                    <div class="skeleton h-4 w-4 rounded"></div>
                    <div class="skeleton h-4 w-3/4 rounded ml-2"></div>
                    <div class="skeleton h-6 w-8 rounded ml-auto"></div>
                    <div class="skeleton h-4 w-6 rounded ml-auto"></div>
                </div>
            `).join('');
        }

        function setView(view) {
            document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${view}`).classList.remove('hidden');
            document.querySelectorAll('header button').forEach(el => el.classList.remove('active-tab'));
            document.getElementById(`tab-${view}`).classList.add('active-tab');
            refreshData();
        }

        const createRow = (p, index) => {
            const keys = Object.keys(p);
            const rank = p[keys[0]] || "-";
            const name = p[keys[1]] || "Unknown";
            const score = p[keys[2]] || "E";
            const holes = p[keys[3]] || "0";
            const isUnder = String(score).startsWith('-');
            const isFav = favorites.includes(name);

            return `
                <div class="bg-white py-2.5 px-3 rounded-xl shadow-sm border border-gray-200 lb-grid row-animate" style="animation-delay: ${index * 0.05}s">
                    <div class="rank-cell tabular-nums">${rank}</div>
                    <div class="name-cell">
                        <span onclick="toggleFavorite('${name}')" class="fav-star ${isFav ? 'active' : ''}">${isFav ? '★' : '☆'}</span>
                        ${getLogoHtml(name)}
                        <span class="name-text">${name}</span>
                    </div>
                    <div class="score-cell tabular-nums ${isUnder ? 'text-red-600' : 'text-gray-800'}">${score}</div>
                    <div class="holes-cell tabular-nums">${holes}</div>
                </div>
            `;
        };

        async function fetchLeaderboard(type = 'individual') {
            const listId = type === 'individual' ? 'leaderboard-list' : 'teams-list';
            const list = document.getElementById(listId);
            list.innerHTML = createSkeleton(10);
            
            try {
                const res = await fetch(`${DEPLOY_URL}?action=getLeaderboard`);
                const data = await res.json();
                
                let results = [];
                let isTeamSection = false;

                data.forEach((p, index) => {
                    const keys = Object.keys(p);
                    const nameVal = String(p[keys[1]] || "").trim().toUpperCase();
                    if (index >= 13 || nameVal.includes("TEAM") || nameVal.includes("LEADERS")) {
                        if (!isTeamSection && (nameVal.includes("TEAM") || index >= 13)) isTeamSection = true;
                    }
                    if (nameVal === "PLAYER" || nameVal === "TEAM" || nameVal === "" || nameVal.includes("TEAM LEADERS")) return;

                    if (type === 'individual' && !isTeamSection) results.push(p);
                    else if (type === 'team' && isTeamSection) results.push(p);
                });

                // Update branding based on #1
                if (results.length > 0) updateBranding(results[0][Object.keys(results[0])[1]]);

                // Sort favorites to top
                results.sort((a, b) => {
                    const aFav = favorites.includes(a[Object.keys(a)[1]]) ? 1 : 0;
                    const bFav = favorites.includes(b[Object.keys(b)[1]]) ? 1 : 0;
                    return bFav - aFav;
                });

                let html = `<div class="giant-header mt-1">${type === 'individual' ? 'Leaderboard' : 'Team Standings'}</div>
                            <div class="sub-header-labels"><div>RK</div><div class="text-center">${type === 'individual' ? 'PLAYER' : 'TEAM'}</div><div class="text-center">SC</div><div class="text-right">THRU</div></div>`;
                
                list.innerHTML = html + results.map((p, i) => createRow(p, i)).join('');
            } catch (e) { list.innerHTML = `<div class="p-10 text-center text-red-500 font-bold">Connection Error.</div>`; }
        }

        async function fetchPlayerScores() {
            const list = document.getElementById('scores-list');
            list.innerHTML = createSkeleton(8);
            try {
                const res = await fetch(`${DEPLOY_URL}?action=getAllScores`);
                const data = await res.json();
                const players = data.slice(2).filter(p => p[Object.keys(p)[2]] && p[Object.keys(p)[2]] !== "Player Name");
                
                list.innerHTML = `<div class="sub-header-labels grid-cols-3 !grid" style="grid-template-columns: 1fr 55px 45px"><div>PLAYER</div><div class="text-center">SC</div><div class="text-right">THRU</div></div>` + 
                players.map((p, i) => {
                    const keys = Object.keys(p);
                    const name = p[keys[2]]; const thru = p[keys[24]] || "0"; const score = p[keys[25]] || "E";
                    const isUnder = String(score).startsWith('-');
                    return `
                        <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between row-animate" style="animation-delay: ${i*0.02}s">
                            <span class="font-bold text-gray-800 uppercase flex items-center overflow-hidden flex-1">
                                ${getLogoHtml(name)}
                                <span class="truncate text-[0.85rem]">${name}</span>
                            </span>
                            <span class="w-14 text-center tabular-nums text-lg font-black ${isUnder ? 'text-red-600' : 'text-green-800'}">${score}</span>
                            <span class="w-10 text-right tabular-nums text-xs font-bold text-gray-400">${thru}</span>
                        </div>`;
                }).join('');
            } catch (e) { list.innerHTML = `<div class="p-10 text-center text-red-500">Error.</div>`; }
        }

        // Pull to refresh logic
        let startY = 0;
        document.addEventListener('touchstart', e => { startY = e.touches[0].pageY; }, {passive: true});
        document.addEventListener('touchmove', e => {
            const y = e.touches[0].pageY;
            if (window.scrollY === 0 && y > startY) {
                const diff = Math.min((y - startY) / 2, 60);
                document.getElementById('pull-to-refresh').style.height = diff + 'px';
            }
        }, {passive: true});
        document.addEventListener('touchend', e => {
            const ptr = document.getElementById('pull-to-refresh');
            if (parseInt(ptr.style.height) > 50) refreshData();
            ptr.style.height = '0px';
        });

        async function loadGroupPlayers() {
            const groupVal = document.getElementById('groupSelect').value;
            const container = document.getElementById('group-player-inputs');
            if (!groupVal) return container.innerHTML = "";
            const groupTab = groupVal.replace("Group ", "G");
            container.innerHTML = `<div class="flex justify-center py-4"><div class="skeleton h-8 w-full rounded-xl opacity-20"></div></div>`;
            try {
                const res = await fetch(`${DEPLOY_URL}?action=getGroupPlayers&groupTab=${encodeURIComponent(groupTab)}`);
                const players = await res.json();
                container.innerHTML = players.filter(n => n && n !== "Name" && n !== "Hole").map(name => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl border border-gray-200">
                        <span class="font-bold text-gray-700 text-[0.8rem] uppercase flex items-center truncate mr-2">
                            ${getLogoHtml(name)} ${name}
                        </span>
                        <input type="number" inputmode="numeric" data-player="${name}" placeholder="Par" class="player-score-input w-16 p-2 border-2 rounded-lg text-center font-bold text-xl outline-none focus:border-green-500">
                    </div>
                `).join('');
                document.getElementById('submitBtn').disabled = false;
            } catch (e) { container.innerHTML = `<div class="text-red-500 text-center">Error.</div>`; }
        }

        async function submitScores() {
            const groupVal = document.getElementById('groupSelect').value;
            const groupTab = groupVal.replace("Group ", "G");
            const hole = document.getElementById('holeSelect').value;
            const btn = document.getElementById('submitBtn');
            const scores = {};
            let hasScores = false;
            document.querySelectorAll('.player-score-input').forEach(i => { 
                if(i.value) { scores[i.getAttribute('data-player')] = i.value; hasScores = true; }
            });
            if (!hasScores) return showStatus("Enter a score.", false);
            btn.disabled = true; btn.innerText = "SUBMITTING...";
            try {
                const response = await fetch(DEPLOY_URL, { method: 'POST', body: JSON.stringify({ groupTab, holeNum: hole, scores }) });
                const result = await response.json();
                if (result.result === "success") {
                    showStatus(`✓ Hole ${hole} updated!`, true);
                    document.querySelectorAll('.player-score-input').forEach(i => i.value = '');
                } else showStatus("Submission failed.", false);
            } catch (e) { showStatus("Network error.", false); }
            finally { btn.disabled = false; btn.innerText = "SUBMIT SCORES"; }
        }

        function showStatus(msg, success) {
            const s = document.getElementById('statusMsg');
            s.innerText = msg; s.className = `text-center p-3 rounded-lg block font-bold mt-3 ${success ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            s.classList.remove('hidden'); setTimeout(() => s.classList.add('hidden'), 5000);
        }

        function filterPlayerScores(q) {
            const items = document.querySelectorAll('.view:not(.hidden) .row-animate');
            const searchTerm = q.toLowerCase();
            items.forEach(i => i.style.display = i.innerText.toLowerCase().includes(searchTerm) ? '' : 'none');
        }

        function refreshData() {
            const active = document.querySelector('header button.active-tab').id;
            if (active === 'tab-leaderboard') fetchLeaderboard('individual');
            if (active === 'tab-teams') fetchLeaderboard('team');
            if (active === 'tab-scores') fetchPlayerScores();
        }

        window.onload = () => { initLogos(); fetchLeaderboard('individual'); };
    </script>
</body>
</html>
